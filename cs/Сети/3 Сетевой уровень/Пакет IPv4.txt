Заголовок пакета IPv4

Заголовок пакета IPv4 обычно весит 20 байт (или 160 бит) при отсутствии дополнительных опций. Это минимальный размер, который может увеличиваться до 60 байт (или 480 бит) в случае наличия опций. 

	- Версия (4 бита). Содержит 4-битное двоичное значение, определяющее версию IP-пакета. Для пакетов IPv4 в этом поле всегда указано значение 0100 (4). Тогда как в поле IPv6 указано 0110 (6).

	- Размер заголовка (4 бита. Internet Header Length - IHL). Указывает значение длины заголовка, измеренное в 32-битовых словах. Обычно заголовок IP-пакета имеет длину в 20 байт (пять 32-битовых слов), но при увеличении объема служебной информации эта длина может быть увеличена. Наибольший заголовок занимает 60 октетов.

	- Дифференцированные сервисы (6 бит, Differentiated Services Code Point - DSCP) - это поле в заголовке IPv4, используемое для маркировки пакетов с целью управления качеством обслуживания в сетях. Оно позволяет классифицировать трафик и приоритизировать его, что особенно важно для чувствительных к задержкам приложений, таких как голосовая связь и потоковое видео. Механизм может применяться, например, для снижения задержки чувствительного сетевого трафика вроде голосовой связи и потокового мультимедиа, тогда как остальной трафик будет идти без приоритизации. Маршрутизаторы и компьютеры могут принимать во внимание приоритет пакета и обрабатывать более важные пакеты в первую очередь. DSCP использует 6-битное поле 8-битного IP-заголовка DS. Для IPv4 используется пространство устаревшего заголовка ToS, который разделён на поля DSCP и ECN. Заменяет старое поле Type of Service (ToS).

	- Длина пакета (16 бит, Total Length) - 16-битная полная длина пакета в байтах, включая заголовок и данные. Минимальный размер равен 20 байтам (заголовок без данных), максимальный - 65535 байт. Хосты должны поддерживать передачу пакетов размером до 576 байт, но современные реализации обычно поддерживают гораздо больший размер. Пакеты большего размера, чем поддерживает канал связи, фрагментируются.

	- Идентификатор (16 бит, Identification) - используется для распознавания пакетов, образовавшихся путем фрагментации исходного пакета. Все фрагменты должны иметь одинаковое значение этого поля. 

		При фрагментации каждый фрагмент получает одинаковый идентификатор, что предотвращает путаницу между фрагментами различных пакетов. Поле смещения фрагмента дополнительно указывает позицию каждого фрагмента в исходном пакете, что облегчает сборку. Поле может принимать значения от 0 до 65535.

	- Флаги (3 бит, Flags) - поле используется для управления фрагментацией пакетов. Оно позволяет маршрутизатору и другим сетевым устройствам определять, как обрабатывать фрагменты данных. Основные функции этого поля включают:

		1. Не фрагментировать (DF - Don't fragment) - указывает, что пакет не должен быть фрагментирован. Если пакет слишком велик для передачи через сеть с меньшим максимальным размером передаваемого блока (MTU), он будет отброшен.

		2. Больше фрагментов (MF - More fragments) - указывает, что пакет является частью фрагментированного сообщения. Этот флаг указывает получателю, что существуют дополнительные фрагменты, которые необходимо собрать. Если MF равен 0, это означает, что текущий фрагмент является последним.

		3. Резервный бит - этот бит обычно не используется и зарезервирован для будущих нужд (равен нулю).

	- Смещение фрагмента (13 бит, Fragment Offset) - поле указывает положение текущего фрагмента относительно начала оригинального пакета.

		- Размер: Поле занимает 13 бит, что позволяет задавать смещение в диапазоне от 0 до 8191. Смещение фрагментов измеряется в еденицах по 8 байт. Это значит, что фактическое смещение в байтах вычисляется как значение поля, умноженное на 8. Например, если значение поля равно 1, фактическое смещение составляет 8 байт. Максимальное смещение в байтах составляет 8191 * 8 = 655288191 * 8 = 65528 байт.

		- Функция: Смещение используется для правильной сборки фрагментированных пакетов. Каждый фрагмент получает значение смещения, которое указывает, с какого места в исходном пакете начинается данный фрагмент. Это позволяет получателю корректно восстанавливать полный пакет независимо от порядка получения фрагментов.

		- Примеры использования: 

			Предположим, у нас есть пакет размером 4000 байт, который необходимо передать через сеть с MTU 1500 байт. В этом случае пакет будет разделен на три фрагмента:

				1. Первый фрагмент: содержит 1480 байт полезных данных (1480 + 20 байт заголовка IP), смещение равно 0.

				2. Второй фрагмент: также содержит 1480 байт полезных данных, смещение будет 1480 / 8 = 185

				3. Третий фрагмент: содержит оставшиеся данные (1040 байт), смещение будет (1480 * 2) / 8 = 370.

	- Время жизни (8 бит, Time-to-Live, TTL) - поле содержит 8-битное двоичное значение, используемое для ограничения времени существования пакета. Отправитель пакета устанавливает начальное значение времени существования (TTL), которое уменьшается на единицу каждый раз при обработке пакета маршрутизатором. Если значение в поле TTL уменьшается до нуля, маршрутизатор отбрасывает пакет и отправляет на IP-адрес источника ICMP сообщение Time Exceeded (используется для уведомления отправителя о том, что пакет не смог достичь своей цели из-за исчерпания значения Time to Live). Поскольку маршрутизатор уменьшает TTL каждого пакета, он также должен пересчитать контрольную сумму заголовка.

	- Протокол (8 бит, Protocol) - поле используется для определения протокола следующего уровня. Оно содержит код протокола, который был помещен отправителем в IP-пакет. Эти коды регламентированы и перечислены на сайте IANA. Обычно используются значения ICMP (1), IGMP(2), TCP (6) и UDP (17).

	- Контрольная сумма заголовка (16 бит, Header Checksum) - расчитывается только по заголовку. Поскольку некоторые поля заголовка меняют свое значение в процессе передачи пакета по сети (например, время жизни), контрольная сумма проверяется и повторно рассчитывается при каждой обработке IP- заголовка.